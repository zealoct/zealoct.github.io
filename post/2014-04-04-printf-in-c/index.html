<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>printf_in_c &middot; jc han</title>

  
  <link rel="stylesheet" href="http://hanjc.me/css/poole.css">
  <link rel="stylesheet" href="http://hanjc.me/css/hyde.css">
  <link rel="stylesheet" href="http://hanjc.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://hanjc.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://hanjc.me/css/hyde-x.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body>
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>jc han</h1>
      
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://hanjc.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/zealoct"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      <a href="@zealoct"><i class="fa fa-twitter-square fa-3x"></i></a>
      </li>
    </ul>

    <p>Copyright &copy; 2015 <a href="http://hanjc.me/license">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>printf_in_c</h1>
    <span class="post-date">Apr 4, 2014 &middot; 2 minute read &middot; <a href="http://hanjc.me/post/2014-04-04-printf-in-c/#disqus_thread">Comments</a>
    
    <br/>
    
    
    </span>
    <p>这两天讨论起 c 中<code>*p++</code>的行为，特意写了个小程序想要验证一下：</p>

<pre><code class="language-c">main () {
	int a[3] = {0xdeaa, 0xdeab, 0xdeac};
	int *p = a;
	int *p1 = a;
	int *p2 = a;
	
	printf(&quot;%x, %x, %x\n&quot;,  (int)(*p++), (int)(*(p1++)), (int)(++(*p2)));
}
</code></pre>

<!-- more -->

<p>我期待的输出结果是这样的：</p>

<pre><code>0xdeaa, 0xdeaa, 0xdeab
</code></pre>

<p>然而实际的输出却是这样的：</p>

<pre><code>0xdeab, 0xdeab, 0xdeaa
</code></pre>

<p>完完全全相反啊妈蛋！我心目中的<code>*p++</code>应该是先执行<code>p++</code>，然后返回未增加之前 p 的值 pp，之后对 pp 进行解引用，最终返回<code>*pp</code>的值，而 p 应该等于 pp+4。执行效果等价于<code>(*p); p++</code>，但是从输出结果看来仿佛是<code>p++; (*p)</code>，肯定是哪里不对。</p>

<p>观察发现 a[0]+1 的值和 a[1] 相等，都是 0xdeab，因此事实上并不能知道输出的 0xdeab 到底是怎么来的，所以首先把数组 a 的初始值改成</p>

<pre><code>int a[3] = {0xdea0, 0xdea5, 0xdeaa};
</code></pre>

<p>这次的输出是</p>

<pre><code>0xdea1, 0xdea1, 0xdea0
</code></pre>

<p>所以，看来并不如想像的那样，仿佛<code>*p++</code>被执行成了<code>(*p)++</code>了。但这是不对的，而且就算是后者，也应该是先返回 *p 的值，然后再加对 p 所指向的内存加 1。而且毫无疑问第一个输出<code>*p++</code>会影响第二个输出<code>*(p1++)</code>的结果，所以事实并不是这样。不如来看下汇编吧：</p>

<pre><code class="language-c">00000000004004f4 &lt;main&gt;:
  4004f4:   55                      push   %rbp
  4004f5:   48 89 e5                mov    %rsp,%rbp
  4004f8:   48 83 ec 30             sub    $0x30,%rsp
  4004fc:   c7 45 d0 a0 de 00 00    movl   $0xdea0,-0x30(%rbp) // a[0]
  400503:   c7 45 d4 a5 de 00 00    movl   $0xdea5,-0x2c(%rbp) // a[1]
  40050a:   c7 45 d8 aa de 00 00    movl   $0xdeaa,-0x28(%rbp) // a[2]
  400511:   48 8d 45 d0             lea    -0x30(%rbp),%rax    
  400515:   48 89 45 f8             mov    %rax,-0x8(%rbp)     // p
  400519:   48 8d 45 d0             lea    -0x30(%rbp),%rax    
  40051d:   48 89 45 f0             mov    %rax,-0x10(%rbp)    // p1
  400521:   48 8d 45 d0             lea    -0x30(%rbp),%rax
  400525:   48 89 45 e8             mov    %rax,-0x18(%rbp)    // p2
  400529:   48 8b 45 e8             mov    -0x18(%rbp),%rax    // rax = p2
  40052d:   8b 00                   mov    (%rax),%eax         // eax = *p2 = 0xdea0
  40052f:   8d 50 01                lea    0x1(%rax),%edx      // edx = eax + 1
  400532:   48 8b 45 e8             mov    -0x18(%rbp),%rax    // rax = p2
  400536:   89 10                   mov    %edx,(%rax)
  400538:   48 8b 45 e8             mov    -0x18(%rbp),%rax
  40053c:   8b 08                   mov    (%rax),%ecx
  40053e:   48 8b 45 f0             mov    -0x10(%rbp),%rax
  400542:   8b 10                   mov    (%rax),%edx
  400544:   48 83 45 f0 04          addq   $0x4,-0x10(%rbp)
  400549:   48 8b 45 f8             mov    -0x8(%rbp),%rax
  40054d:   8b 00                   mov    (%rax),%eax
  40054f:   48 83 45 f8 04          addq   $0x4,-0x8(%rbp)
  400554:   89 c6                   mov    %eax,%esi
  400556:   bf 5c 06 40 00          mov    $0x40065c,%edi
  40055b:   b8 00 00 00 00          mov    $0x0,%eax
  400560:   e8 8b fe ff ff          callq  4003f0 &lt;printf@plt&gt;
  400561:   c9                      leaveq 
  400562:   c3                      retq   
  400563:   90                      nop
</code></pre>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "hanjc";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "hanjc";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</body>
</html>
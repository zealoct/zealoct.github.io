<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>6.824-lab3-notes &middot; jc han</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body>
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>jc han</h1>
      
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/zealoct"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      <a href="@zealoct"><i class="fa fa-twitter-square fa-3x"></i></a>
      </li>
    </ul>

    <p>Copyright &copy; 2015 <a href="/license">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>6.824-lab3-notes</h1>
    <span class="post-date">Feb 21, 2014 &middot; 1 minute read &middot; <a href="/post/2014-02-21-6-dot-824-lab3-notes/#disqus_thread">Comments</a>
    
    <br/>
    
    <a class="label" href="/categories/exercises">Exercises</a><a class="label" href="/categories/distributed-systems">Distributed Systems</a>
    </span>
    

<h2 id="pre-read:6c805deaca0efd9342e0670f4a49bd04">Pre-read</h2>

<ul>
<li><a href="http://pdos.csail.mit.edu/6.824-2013/notes/l05.txt">[Lecture Notes] Fault Tolerance: Paxos</a></li>
<li><a href="http://pdos.csail.mit.edu/6.824-2013/papers/paxos-simple.pdf">[Paper] Paxos Made Simple</a></li>
<li><a href="/reading/papers/paxos-simple.html">My Paxos Notes</a></li>
</ul>

<p>Paxos 键值存储系统包括</p>

<ul>
<li>客户端（ client ）</li>
<li>kvpaxos 服务器（ server ）</li>
<li>Paxos 节点（ peers ）</li>
</ul>

<p>其中 Paxos 节点部分以类库的形式运行在服务器之上，在 lab3 的整体模型类似于 <a href="http://pdos.csail.mit.edu/6.824-2013/papers/paxos-simple.pdf">Paxos Made Simple</a> 第三节提到的状态机，其中 proposer、acceptor 和 learner 都是 Paxos 节点，<strong>把整个键值存储服务看成一个状态机</strong>，它会按照一定的顺序执行客户端发来的所有命令（ Put 请求），每个命令都确定性的把整个状态机向前推进一步。</p>

<p>在这里，这个状态机是由很多服务器共同构成的，这些服务器之间彼此要<strong>保证执行的命令的顺序完全一致</strong>，为此，我们维护一个有序序列 *list*，该序列就是所有服务器应当执行命令的顺序。</p>

<!-- more -->

<h1 id="在服务器收到一个-put-k-v-请求之后:6c805deaca0efd9342e0670f4a49bd04">在服务器收到一个 Put(k, v) 请求之后</h1>

<ol>
<li>在该序列中寻找到当前最小的空位 *list[n]*，也就是新命令应该存储的位置</li>
<li>向 Paxos 节点 propose 在该位置上放置 <em>key=&gt;value</em> 这个命令，注意同时可能有多个服务器尝试向 <em>list[n]</em> 这个位置放置命令，这时 Paxos 负责协调统一，决定最终放置在 <em>list[n]</em> 处的命令应该是什么</li>
<li>对于单个服务器而言，如果最终 Paxos 决定放置在 <em>list[n]</em> 处的命令与其 propose 的相同，则放置命令成功，对 Put 命令的处理结束；反之，则继续尝试在 <em>list[n+1]</em> 处放置其 propose 的命令。</li>
</ol>

<p><strong>How Put(key, value) and px.Start(seq, v) meet?</strong></p>

<p><strong>Log slot?</strong></p>

<p><strong>(* Paxos).Start(seq int, v interface{})</strong></p>

<p><strong>(* Paxos).Status(seq int) (decided bool, v interface{})</strong></p>

<h2 id="part-b:6c805deaca0efd9342e0670f4a49bd04">Part B</h2>

<p>在 Part B 中，要在 Paxos 的基础之上实现一个键值存储系统，改系统所能处理的异常情况包括：</p>

<ul>
<li>TODO</li>
<li>TODO</li>
</ul>

<p>Part B 中存储系统的结构依然包括客户端、服务端，与 Lab2 中不同的是服务端彼此之间利用 Paxos 来达成共识，因此在该部分中 Paxos 是运行在存储系统服务端之下的辅助系统。下文中提到的客户端、服务端均指存储系统的客户端河服务端。</p>

<p>###基本工作原理</p>

<p>服务器本地保存一个请求队列，收到客户端的请求先缓存起来，每次服务器<strong>只处理队列头的请求</strong>。</p>

<p>每个Put请求都要添加一段随机的身份标识，当一个客户端向多个服务器发送请求的时候请求不会被重复处理。</p>

<p>服务器维护一个列表，表示已经达成共识的消息日志（操作历史），当服务器处理一个请求的时候，尝试添加改请求到列表下一个位置，并通过 Paxos 与其他服务器达成共识。为了解决客户端重复请求的情况，服务器应当先检查本地是否包含改身份标识的操作，确认为新操作之后再进行添加请求。当该请求添加成功之后，处理缓存中下一个请求。</p>

<p><strong>如何确定消息应该添加的位置？</strong>
由于 Paxos 在收到 decide 信息的时候并不会主动通知上层，因此当请求到来的时候，服务器端保存的消息日志可能只有 n 个 slot，然而底层的 Paxos 达成共识的已经有 n+m 个了。所以服务器在处理请求队列时应当：<strong>1.</strong> 先同 Paxos 同步信息 <strong>2.</strong> 根据请求的身份标识判断是否是重复请求 <strong>3.</strong> 调用 Paxos.Start <strong>4.</strong> 轮询 Paxos.Status <strong>5.</strong> 请求占位成功，则返回，失败则返回第1步重新执行。</p>

<p>服务器端维护的消息日志与 Paxos 节点中维护的消息列表是相对应的，内容也是一致的。不过服务端列表是完整的，而且包含了语义信息，而 Paxos 作为服务系统，并不了解列表中值的具体意义，而且 Paxos 中维护的列表内容是作为缓冲而存在的，一旦服务器同步了 Paxos 列表中的信息，就可以通过 Paxos.Done 来清空 Paxos 中缓存的信息。</p>

<p><strong>Get请求直接从本地读取数据返回？</strong>
也当成一个操作，请求共识，根据最终决定的操作顺序返回相应的值。</p>

<p>一种可能的问题：客户端向服务器A发送了Put(a)=1的请求之后，又向服务器B发送Put(a)=2请求。因为Paxos请求并没有一个时间戳，所以可能出现发往B的请求先于发往A的请求达成了共识，造成<strong>客户端的不一致</strong></p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "hanjc";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "hanjc";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</body>
</html>